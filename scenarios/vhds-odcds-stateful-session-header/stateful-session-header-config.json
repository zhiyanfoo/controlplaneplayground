{
  "server_address": "localhost:18000",
  "resources": [
    {
      "type_url": "type.googleapis.com/envoy.config.listener.v3.Listener",
      "name": "stateful_session_listener",
      "data": {
        "name": "stateful_session_listener",
        "address": {
          "socket_address": {
            "protocol": "TCP",
            "address": "0.0.0.0",
            "port_value": 10000
          }
        },
        "filter_chains": [
          {
            "filters": [
              {
                "name": "http-connection-manager",
                "typed_config": {
                  "@type": "type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager",
                  "codec_type": "AUTO",
                  "stat_prefix": "stateful_session_grpc",
                  "rds": {
                    "config_source": {
                      "ads": {},
                      "resource_api_version": "V3",
                      "initial_fetch_timeout": "1s"
                    },
                    "route_config_name": "stateful_session_route"
                  },
                  "http_filters": [
                    {
                      "name": "envoy.filters.http.on_demand",
                      "typed_config": {
                        "@type": "type.googleapis.com/envoy.extensions.filters.http.on_demand.v3.OnDemand",
                        "odcds": {
                          "source": {
                            "ads": {},
                            "resource_api_version": "V3"
                          },
                          "timeout": "1s"
                        }
                      }
                    },
                    {
                      "name": "envoy.filters.http.stateful_session",
                      "typed_config": {
                        "@type": "type.googleapis.com/envoy.extensions.filters.http.stateful_session.v3.StatefulSession",
                        "session_state": {
                          "name": "envoy.http.stateful_session.header",
                          "typed_config": {
                            "@type": "type.googleapis.com/envoy.extensions.http.stateful_session.header.v3.HeaderBasedSessionState",
                            "name": "session-header"
                          }
                        }
                      }
                    },
                    {
                      "name": "http-router",
                      "typed_config": {
                        "@type": "type.googleapis.com/envoy.extensions.filters.http.router.v3.Router"
                      }
                    }
                  ],
                  "access_log": [
                    {
                      "name": "envoy.access_loggers.file",
                      "typed_config": {
                        "@type": "type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog",
                        "path": "/dev/stdout",
                        "log_format": {
                          "text_format_source": {
                            "inline_string": "[%START_TIME%] \"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\" %RESPONSE_CODE% %RESPONSE_FLAGS% %GRPC_STATUS%(%GRPC_STATUS_NUMBER%) %BYTES_SENT% %DURATION% CTD %CONNECTION_TERMINATION_DETAILS% URAC %UPSTREAM_REQUEST_ATTEMPT_COUNT% DWBS %DOWNSTREAM_WIRE_BYTES_SENT% USWBR %UPSTREAM_WIRE_BYTES_RECEIVED% UTFR %UPSTREAM_TRANSPORT_FAILURE_REASON% UH %UPSTREAM_HOST% UC %UPSTREAM_CLUSTER% GRPC_MSG %RESP(grpc-message)% SESSION %REQ(session-header)%\n"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            ]
          }
        ]
      }
    },
    {
      "type_url": "type.googleapis.com/envoy.config.route.v3.RouteConfiguration",
      "name": "stateful_session_route",
      "data": {
        "name": "stateful_session_route",
        "vhds": {
          "config_source": {
            "resource_api_version": "V3",
            "api_config_source": {
              "api_type": "DELTA_GRPC",
              "transport_api_version": "V3",
              "grpc_services": [
                {
                  "envoy_grpc": {
                    "cluster_name": "xds_cluster"
                  }
                }
              ]
            },
            "initial_fetch_timeout": "1s"
          }
        }
      }
    },
    {
      "type_url": "type.googleapis.com/envoy.config.cluster.v3.Cluster",
      "name": "stateful_session_cluster",
      "wildcard_node_update": false,
      "data": {
        "name": "stateful_session_cluster",
        "connect_timeout": "5s",
        "type": "EDS",
        "eds_cluster_config": {
          "eds_config": {
            "ads": {},
            "resource_api_version": "V3",
            "initial_fetch_timeout": "1s"
          }
        },
        "lb_policy": "ROUND_ROBIN",
        "typed_extension_protocol_options": {
          "envoy.extensions.upstreams.http.v3.HttpProtocolOptions": {
            "@type": "type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions",
            "explicit_http_config": {
              "http2_protocol_options": {}
            }
          }
        }
      }
    },
    {
      "type_url": "type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment",
      "name": "stateful_session_cluster",
      "data": {
        "cluster_name": "stateful_session_cluster",
        "endpoints": [
          {
            "lb_endpoints": [
              {
                "endpoint": {
                  "address": {
                    "socket_address": {
                      "protocol": "TCP",
                      "address": "127.0.0.1",
                      "port_value": 50053
                    }
                  }
                }
              },
              {
                "endpoint": {
                  "address": {
                    "socket_address": {
                      "protocol": "TCP",
                      "address": "127.0.0.1",
                      "port_value": 50054
                    }
                  }
                }
              }
            ]
          }
        ]
      }
    },
    {
      "type_url": "type.googleapis.com/envoy.config.route.v3.VirtualHost",
      "name": "stateful_session_route/localhost:10000",
      "data": {
        "name": "stateful_session_vh",
        "domains": ["*"],
        "routes": [
          {
            "match": {
              "prefix": "/"
            },
            "route": {
              "cluster": "stateful_session_cluster"
            }
          }
        ]
      }
    }
  ]
}